<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Reservation Gap Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .auth-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        .input-group input {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .status {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status.success {
            background: linear-gradient(135deg, #51cf66, #40c057);
            color: white;
        }

        .status.error {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .status.info {
            background: linear-gradient(135deg, #74c0fc, #339af0);
            color: white;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .metric-label {
            font-size: 1rem;
            color: #666;
            font-weight: 500;
        }

        .metric-trend {
            font-size: 0.9rem;
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        .trend-positive {
            background: rgba(81, 207, 102, 0.1);
            color: #51cf66;
        }

        .trend-negative {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .gap-table {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            font-weight: 600;
            color: #495057;
        }

        tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .gap-positive {
            color: #51cf66;
            font-weight: 600;
        }

        .gap-negative {
            color: #ff6b6b;
            font-weight: 600;
        }

        .setup-instructions {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .setup-instructions h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .setup-instructions ol {
            margin-left: 20px;
            line-height: 1.6;
        }

        .setup-instructions li {
            margin-bottom: 10px;
        }

        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Azure Reservation Gap Analysis</h1>
            <p>Real-time analysis of your Azure VM reservations vs actual usage</p>
        </div>

        <div class="auth-section">
            <h2>Azure Configuration</h2>
            <div class="config-grid">
                <div class="input-group">
                    <label for="clientId">Client ID</label>
                    <input type="text" id="clientId" placeholder="Your Azure App Registration Client ID">
                </div>
                <div class="input-group">
                    <label for="tenantId">Tenant ID</label>
                    <input type="text" id="tenantId" placeholder="Your Azure AD Tenant ID">
                </div>
                <div class="input-group">
                    <label for="subscriptionId">Subscription ID</label>
                    <input type="text" id="subscriptionId" placeholder="Your Azure Subscription ID">
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="authenticateAzure()">Connect to Azure</button>
                <button class="btn btn-secondary" onclick="loadSampleData()">Load Sample Data</button>
            </div>

            <div id="authStatus"></div>
        </div>

        <div id="dashboard" class="dashboard">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalReservations">-</div>
                    <div class="metric-label">Total Reservations</div>
                    <div class="metric-trend trend-positive" id="reservationTrend">+12% vs last month</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="activeVMs">-</div>
                    <div class="metric-label">Active VMs</div>
                    <div class="metric-trend trend-negative" id="vmTrend">-3% vs last month</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="utilizationRate">-</div>
                    <div class="metric-label">Utilization Rate</div>
                    <div class="metric-trend" id="utilizationTrend">85% target</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="costImpact">-</div>
                    <div class="metric-label">Monthly Cost Gap</div>
                    <div class="metric-trend trend-negative" id="costTrend">Optimization needed</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Reservation vs Usage by Region</div>
                <canvas id="regionChart" width="400" height="200"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">VM Size Distribution Gap Analysis</div>
                <canvas id="sizeChart" width="400" height="200"></canvas>
            </div>

            <div class="gap-table">
                <div class="chart-title">Detailed Gap Analysis</div>
                <table id="gapTable">
                    <thead>
                        <tr>
                            <th>Region</th>
                            <th>VM Size</th>
                            <th>Reserved</th>
                            <th>Actual Usage</th>
                            <th>Gap</th>
                            <th>Cost Impact</th>
                            <th>Recommendation</th>
                        </tr>
                    </thead>
                    <tbody id="gapTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="setup-instructions">
            <h3>üîß Setup Instructions</h3>
            <ol>
                <li><strong>Update your Azure App Registration redirect URI to:</strong>
                    <div class="code" id="redirectUri">https://your-static-app-url.azurestaticapps.net</div>
                </li>
                <li><strong>Required API Permissions:</strong>
                    <ul>
                        <li>Microsoft Graph ‚Üí User.Read</li>
                        <li>Azure Service Management ‚Üí user_impersonation</li>
                        <li>Grant admin consent</li>
                    </ul>
                </li>
                <li><strong>Required Azure RBAC Roles:</strong>
                    <ul>
                        <li><strong>Reader</strong> role on subscription (for VM data)</li>
                        <li><strong>Reservation Purchaser</strong> role (for reservation data)</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <script>
        // Update redirect URI display with current URL
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('redirectUri').textContent = window.location.origin;
        });

        let msalInstance;
        let accessToken;
        let azureConfig = {};

        // Sample data for demonstration
        const sampleData = {
            reservations: [
                { region: 'East US', vmSize: 'Standard_D2s_v3', quantity: 10, cost: 1200 },
                { region: 'East US', vmSize: 'Standard_D4s_v3', quantity: 5, cost: 1800 },
                { region: 'West US', vmSize: 'Standard_D2s_v3', quantity: 8, cost: 960 },
                { region: 'West Europe', vmSize: 'Standard_D8s_v3', quantity: 3, cost: 2400 },
                { region: 'Southeast Asia', vmSize: 'Standard_D2s_v3', quantity: 6, cost: 720 }
            ],
            actualVMs: [
                { region: 'East US', vmSize: 'Standard_D2s_v3', quantity: 8 },
                { region: 'East US', vmSize: 'Standard_D4s_v3', quantity: 7 },
                { region: 'West US', vmSize: 'Standard_D2s_v3', quantity: 8 },
                { region: 'West Europe', vmSize: 'Standard_D8s_v3', quantity: 2 },
                { region: 'Southeast Asia', vmSize: 'Standard_D2s_v3', quantity: 4 },
                { region: 'Central US', vmSize: 'Standard_D2s_v3', quantity: 3 }
            ]
        };

        function initializeMSAL() {
            const clientId = document.getElementById('clientId').value.trim();
            const tenantId = document.getElementById('tenantId').value.trim();
            
            if (!clientId || !tenantId) {
                showStatus('‚ùå Please enter both Client ID and Tenant ID', 'error');
                return false;
            }

            azureConfig = {
                clientId: clientId,
                tenantId: tenantId,
                subscriptionId: document.getElementById('subscriptionId').value.trim()
            };

            try {
                msalInstance = new msal.PublicClientApplication({
                    auth: {
                        clientId: clientId,
                        authority: `https://login.microsoftonline.com/${tenantId}`,
                        redirectUri: window.location.origin
                    },
                    cache: {
                        cacheLocation: "memory"
                    }
                });
                
                return true;
                
            } catch (error) {
                console.error('‚ùå MSAL initialization error:', error);
                showStatus(`‚ùå MSAL initialization failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function authenticateAzure() {
            if (!initializeMSAL()) return;

            try {
                showStatus('Authenticating with Azure...', 'info');
                
                const loginRequest = {
                    scopes: ["https://management.azure.com/user_impersonation", "openid", "profile"]
                };

                const response = await msalInstance.loginPopup(loginRequest);
                accessToken = response.accessToken;
                
                showStatus(`‚úÖ Successfully authenticated as ${response.account.username}`, 'success');
                
                // Load real Azure data
                await loadAzureData();
                
            } catch (error) {
                console.error('Authentication failed:', error);
                showStatus(`‚ùå Authentication failed: ${error.message}`, 'error');
            }
        }

        async function loadAzureData() {
    try {
        showStatus('üîÑ Fetching Azure reservation and VM data...', 'info');
        
        if (!accessToken || !azureConfig.subscriptionId) {
            throw new Error('Missing access token or subscription ID');
        }

        const headers = {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
        };

        // Run diagnostics first
        showStatus('üîç Running connectivity diagnostics...', 'info');
        const diagnostics = await diagnoseAzureConnectivity();
        
        if (diagnostics.error) {
            throw new Error(`Connectivity check failed: ${diagnostics.error}`);
        }
        
        if (!diagnostics.subscriptionAccess) {
            throw new Error('Cannot access subscription. Check your permissions.');
        }
        
        if (!diagnostics.vmApiAccess) {
            if (diagnostics.vmApiStatus === 502) {
                showStatus('‚ö†Ô∏è Azure VM API is experiencing issues (502 error). Trying alternative methods...', 'info');
            } else {
                throw new Error(`VM API not accessible (${diagnostics.vmApiStatus}). Check your permissions.`);
            }
        }

        // Fetch reservations and VMs in parallel with enhanced error handling
        showStatus('üìä Fetching reservations and VM data...', 'info');
        
        const results = await Promise.allSettled([
            fetchReservations(headers),
            fetchVMs(headers)
        ]);
        
        const reservationsResult = results[0];
        const vmsResult = results[1];
        
        let reservationsData = [];
        let vmsData = [];
        
        if (reservationsResult.status === 'fulfilled') {
            reservationsData = reservationsResult.value;
            console.log(`‚úÖ Loaded ${reservationsData.length} reservations`);
        } else {
            console.warn('‚ùå Reservations fetch failed:', reservationsResult.reason);
            showStatus('‚ö†Ô∏è Could not load reservations data, using VMs only...', 'info');
        }
        
        if (vmsResult.status === 'fulfilled') {
            vmsData = vmsResult.value;
            console.log(`‚úÖ Loaded ${vmsData.length} VM configurations`);
        } else {
            console.warn('‚ùå VMs fetch failed:', vmsResult.reason);
            throw new Error(`Could not load VM data: ${vmsResult.reason.message}`);
        }
        
        const processedData = {
            reservations: reservationsData,
            actualVMs: vmsData
        };
        
        processGapAnalysis(processedData);
        
        let statusMessage = '‚úÖ Real Azure data loaded successfully!';
        if (reservationsData.length === 0) {
            statusMessage += ' (No reservations found - showing VM usage only)';
        }
        showStatus(statusMessage, 'success');
        
    } catch (error) {
        console.error('Data loading failed:', error);
        
        // Provide specific guidance based on error type
        let errorMessage = `‚ùå Failed to load Azure data: ${error.message}`;
        let shouldShowFallback = true;
        
        if (error.message.includes('502')) {
            errorMessage += '\n\nüí° Azure is experiencing server issues. This is temporary - try again in a few minutes.';
        } else if (error.message.includes('401') || error.message.includes('403')) {
            errorMessage += '\n\nüîë Permission issue. Ensure you have Reader role on the subscription.';
            shouldShowFallback = false;
        } else if (error.message.includes('subscription')) {
            errorMessage += '\n\nüìã Check your Subscription ID is correct.';
            shouldShowFallback = false;
        }
        
        showStatus(errorMessage, 'error');
        
        if (shouldShowFallback) {
            // Fallback to sample data with warning
            setTimeout(() => {
                showStatus('‚ö†Ô∏è Using sample data as fallback. Check console for detailed error information.', 'error');
                processGapAnalysis(sampleData);
            }, 3000);
        }
    }
}

async function fetchReservations(headers) {
    try {
        // Get all reservations for the tenant
        const reservationsUrl = `https://management.azure.com/providers/Microsoft.Capacity/reservationOrders?api-version=2022-03-01`;
        
        const reservationsResponse = await fetch(reservationsUrl, { headers });
        
        if (!reservationsResponse.ok) {
            throw new Error(`Reservations API error: ${reservationsResponse.status} ${reservationsResponse.statusText}`);
        }
        
        const reservationsResult = await reservationsResponse.json();
        const reservations = [];
        
        // Process each reservation order
        for (const order of reservationsResult.value || []) {
            if (order.properties?.reservations) {
                for (const reservation of order.properties.reservations) {
                    try {
                        // Get detailed reservation info
                        const detailUrl = `https://management.azure.com${reservation.id}?api-version=2022-03-01`;
                        const detailResponse = await fetch(detailUrl, { headers });
                        
                        if (detailResponse.ok) {
                            const detail = await detailResponse.json();
                            const props = detail.properties;
                            
                            // Only include VM reservations that are active
                            if (props?.sku?.name?.includes('VM') && 
                                props?.provisioningState === 'Succeeded' &&
                                props?.effectiveDateTime && 
                                props?.expiryDateTime &&
                                new Date(props.effectiveDateTime) <= new Date() &&
                                new Date(props.expiryDateTime) > new Date()) {
                                
                                reservations.push({
                                    region: props.appliedScopeProperties?.displayName || props.location || 'Unknown',
                                    vmSize: props.sku.name,
                                    quantity: props.quantity || 1,
                                    cost: calculateReservationCost(props),
                                    term: props.term,
                                    scope: props.appliedScopeType
                                });
                            }
                        }
                    } catch (detailError) {
                        console.warn('Failed to fetch reservation detail:', detailError);
                    }
                }
            }
        }
        
        return reservations;
        
    } catch (error) {
        console.error('Error fetching reservations:', error);
        throw new Error(`Failed to fetch reservations: ${error.message}`);
    }
}

async function fetchVMs(headers) {
    try {
        console.log('üîç Attempting to fetch VMs with multiple strategies...');
        
        // Strategy 1: Try without instanceView expansion first (more reliable)
        let vmsData = await tryFetchVMsBasic(headers);
        
        // Strategy 2: If basic fetch works, try to get power states separately
        if (vmsData.length > 0) {
            vmsData = await enrichWithPowerStates(vmsData, headers);
        } else {
            // Strategy 3: Try paginated approach for large subscriptions
            vmsData = await tryFetchVMsPaginated(headers);
        }
        
        // Strategy 4: If all fails, try Resource Graph API (if available)
        if (vmsData.length === 0) {
            vmsData = await tryResourceGraphAPI(headers);
        }
        
        const vmUsage = new Map();
        
        // Process VMs and group by region and size
        vmsData.forEach(vm => {
            const region = vm.location;
            const vmSize = vm.vmSize;
            const isRunning = vm.isRunning;
            
            if (region && vmSize && isRunning) {
                const key = `${region}-${vmSize}`;
                const current = vmUsage.get(key) || { region, vmSize, quantity: 0 };
                current.quantity += 1;
                vmUsage.set(key, current);
            }
        });
        
        console.log(`‚úÖ Successfully processed ${vmsData.length} VMs, ${vmUsage.size} unique region/size combinations`);
        return Array.from(vmUsage.values());
        
    } catch (error) {
        console.error('Error fetching VMs:', error);
        throw new Error(`Failed to fetch VMs: ${error.message}`);
    }
}

async function tryFetchVMsBasic(headers) {
    try {
        console.log('üìç Strategy 1: Basic VM fetch without instanceView...');
        const vmsUrl = `https://management.azure.com/subscriptions/${azureConfig.subscriptionId}/providers/Microsoft.Compute/virtualMachines?api-version=2023-03-01`;
        
        const response = await makeAzureApiCall(vmsUrl, headers);
        
        return (response.value || []).map(vm => ({
            id: vm.id,
            name: vm.name,
            location: vm.location,
            vmSize: vm.properties?.hardwareProfile?.vmSize,
            isRunning: true // Assume running for basic fetch, will verify later
        }));
        
    } catch (error) {
        console.warn('Basic VM fetch failed:', error.message);
        return [];
    }
}

async function enrichWithPowerStates(vmsData, headers) {
    console.log('üîã Strategy 2: Enriching with power states...');
    const enrichedVMs = [];
    
    // Process VMs in batches to avoid overwhelming the API
    const batchSize = 10;
    for (let i = 0; i < vmsData.length; i += batchSize) {
        const batch = vmsData.slice(i, i + batchSize);
        
        const batchPromises = batch.map(async (vm) => {
            try {
                const statusUrl = `${vm.id}/instanceView?api-version=2023-03-01`;
                const statusResponse = await makeAzureApiCall(`https://management.azure.com${statusUrl}`, headers);
                
                const isRunning = statusResponse.statuses?.some(
                    status => status.code === 'PowerState/running'
                );
                
                return { ...vm, isRunning };
                
            } catch (error) {
                console.warn(`Failed to get status for ${vm.name}, assuming running:`, error.message);
                return { ...vm, isRunning: true }; // Conservative assumption
            }
        });
        
        const batchResults = await Promise.allSettled(batchPromises);
        batchResults.forEach(result => {
            if (result.status === 'fulfilled') {
                enrichedVMs.push(result.value);
            }
        });
        
        // Rate limiting: wait between batches
        if (i + batchSize < vmsData.length) {
            await new Promise(resolve => setTimeout(resolve, 500));
        }
    }
    
    return enrichedVMs;
}

async function tryFetchVMsPaginated(headers) {
    try {
        console.log('üìÑ Strategy 3: Paginated VM fetch...');
        const allVMs = [];
        let nextLink = `https://management.azure.com/subscriptions/${azureConfig.subscriptionId}/providers/Microsoft.Compute/virtualMachines?api-version=2023-03-01&$top=50`;
        
        while (nextLink && allVMs.length < 1000) { // Safety limit
            const response = await makeAzureApiCall(nextLink, headers);
            
            const vms = (response.value || []).map(vm => ({
                id: vm.id,
                name: vm.name,
                location: vm.location,
                vmSize: vm.properties?.hardwareProfile?.vmSize,
                isRunning: true // Will verify separately if needed
            }));
            
            allVMs.push(...vms);
            nextLink = response.nextLink;
            
            // Rate limiting between pages
            if (nextLink) {
                await new Promise(resolve => setTimeout(resolve, 200));
            }
        }
        
        return allVMs;
        
    } catch (error) {
        console.warn('Paginated VM fetch failed:', error.message);
        return [];
    }
}

async function tryResourceGraphAPI(headers) {
    try {
        console.log('üîç Strategy 4: Trying Azure Resource Graph API...');
        
        const query = {
            query: `
                Resources
                | where type == "microsoft.compute/virtualmachines"
                | where subscriptionId == "${azureConfig.subscriptionId}"
                | extend vmSize = properties.hardwareProfile.vmSize
                | extend powerState = properties.extended.instanceView.powerState.code
                | project name, location, vmSize, powerState
                | where powerState == "PowerState/running" or isempty(powerState)
            `
        };
        
        const graphUrl = 'https://management.azure.com/providers/Microsoft.ResourceGraph/resources?api-version=2021-03-01';
        const response = await fetch(graphUrl, {
            method: 'POST',
            headers: {
                ...headers,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(query)
        });
        
        if (response.ok) {
            const result = await response.json();
            return (result.data || []).map(row => ({
                name: row[0],
                location: row[1],
                vmSize: row[2],
                isRunning: !row[3] || row[3] === 'PowerState/running'
            }));
        }
        
    } catch (error) {
        console.warn('Resource Graph API failed:', error.message);
    }
    
    return [];
}

function calculateReservationCost(reservationProps) {
    // Estimate monthly cost based on reservation properties
    // This is a simplified calculation - actual billing data would require different APIs
    
    const quantity = reservationProps.quantity || 1;
    const term = reservationProps.term || 'P1Y';
    
    // Basic cost estimates per VM size per month (these would come from Azure pricing API in production)
    const costEstimates = {
        'Standard_D2s_v3': 100,
        'Standard_D4s_v3': 200,
        'Standard_D8s_v3': 400,
        'Standard_D16s_v3': 800,
        'Standard_E2s_v3': 120,
        'Standard_E4s_v3': 240,
        'Standard_E8s_v3': 480,
        'Standard_F2s_v2': 80,
        'Standard_F4s_v2': 160,
        'Standard_F8s_v2': 320
    };
    
    const vmSize = reservationProps.sku?.name || '';
    const baseCost = costEstimates[vmSize] || 150; // Default estimate
    
    // Apply reservation discount (typically 30-70% off pay-as-you-go)
    const reservationDiscount = 0.4; // 40% discount
    const monthlyCost = baseCost * quantity * (1 - reservationDiscount);
    
    return Math.round(monthlyCost);
}

// Additional helper function to refresh access token if needed
async function ensureValidToken() {
    try {
        if (!msalInstance) {
            throw new Error('MSAL not initialized');
        }
        
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length === 0) {
            throw new Error('No authenticated accounts found');
        }
        
        const silentRequest = {
            scopes: ["https://management.azure.com/user_impersonation"],
            account: accounts[0]
        };
        
        const response = await msalInstance.acquireTokenSilent(silentRequest);
        accessToken = response.accessToken;
        return true;
        
    } catch (error) {
        console.warn('Silent token acquisition failed, may need re-authentication:', error);
        return false;
    }
}

// Enhanced error handling and retry logic with 502-specific handling
async function makeAzureApiCall(url, headers, retries = 3) {
    for (let attempt = 0; attempt <= retries; attempt++) {
        try {
            console.log(`üåê API Call attempt ${attempt + 1}: ${url.split('?')[0]}`);
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
            
            const response = await fetch(url, { 
                headers,
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            // Handle specific error cases
            if (response.status === 401 && attempt < retries) {
                console.log('üîÑ Token expired, refreshing...');
                const tokenRefreshed = await ensureValidToken();
                if (tokenRefreshed) {
                    headers['Authorization'] = `Bearer ${accessToken}`;
                    continue;
                }
            }
            
            if (response.status === 502 || response.status === 503 || response.status === 504) {
                if (attempt < retries) {
                    const delay = Math.min(1000 * Math.pow(2, attempt), 10000); // Exponential backoff, max 10s
                    console.warn(`‚ö†Ô∏è Server error ${response.status}, retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue;
                }
            }
            
            if (response.status === 429) { // Rate limited
                const retryAfter = response.headers.get('Retry-After') || '60';
                const delay = Math.min(parseInt(retryAfter) * 1000, 30000); // Max 30s wait
                console.warn(`‚è±Ô∏è Rate limited, waiting ${delay}ms...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                continue;
            }
            
            if (!response.ok) {
                throw new Error(`API call failed: ${response.status} ${response.statusText}`);
            }
            
            return await response.json();
            
        } catch (error) {
            if (error.name === 'AbortError') {
                console.warn('‚è∞ Request timeout');
            }
            
            if (attempt === retries) {
                throw error;
            }
            
            const delay = Math.min(1000 * (attempt + 1), 5000);
            console.warn(`üí• Attempt ${attempt + 1} failed, retrying in ${delay}ms...`, error.message);
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
}

// Add a diagnostic function to help troubleshoot
async function diagnoseAzureConnectivity() {
    console.log('üîç Running Azure connectivity diagnostics...');
    
    try {
        // Test basic subscription access
        const subscriptionUrl = `https://management.azure.com/subscriptions/${azureConfig.subscriptionId}?api-version=2020-01-01`;
        const headers = {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
        };
        
        const subResponse = await fetch(subscriptionUrl, { headers });
        console.log(`üìä Subscription access: ${subResponse.status} ${subResponse.statusText}`);
        
        if (subResponse.ok) {
            const subData = await subResponse.json();
            console.log(`‚úÖ Subscription: ${subData.displayName} (${subData.state})`);
        }
        
        // Test VM API availability with minimal call
        const vmTestUrl = `https://management.azure.com/subscriptions/${azureConfig.subscriptionId}/providers/Microsoft.Compute/virtualMachines?api-version=2023-03-01&$top=1`;
        const vmResponse = await fetch(vmTestUrl, { headers });
        console.log(`üñ•Ô∏è VM API access: ${vmResponse.status} ${vmResponse.statusText}`);
        
        return {
            subscriptionAccess: subResponse.ok,
            vmApiAccess: vmResponse.ok,
            vmApiStatus: vmResponse.status
        };
        
    } catch (error) {
        console.error('‚ùå Diagnostics failed:', error);
        return { error: error.message };
    }
}

        function loadSampleData() {
            showStatus('üìä Loading sample data for demonstration...', 'info');
            setTimeout(() => {
                processGapAnalysis(sampleData);
                showStatus('‚úÖ Sample data loaded! This demonstrates the analysis with mock Azure data.', 'success');
            }, 1000);
        }

        function processGapAnalysis(data) {
            const { reservations, actualVMs } = data;
            
            // Calculate gaps
            const gaps = calculateGaps(reservations, actualVMs);
            
            // Update metrics
            updateMetrics(reservations, actualVMs, gaps);
            
            // Create charts
            createRegionChart(gaps);
            createSizeChart(gaps);
            
            // Populate table
            populateGapTable(gaps);
            
            // Show dashboard
            document.getElementById('dashboard').classList.add('active');
        }

        function calculateGaps(reservations, actualVMs) {
            const gaps = [];
            const reservationMap = new Map();
            const usageMap = new Map();
            
            // Index reservations and actual VMs
            reservations.forEach(r => {
                const key = `${r.region}-${r.vmSize}`;
                reservationMap.set(key, r);
            });
            
            actualVMs.forEach(vm => {
                const key = `${vm.region}-${vm.vmSize}`;
                usageMap.set(key, vm);
            });
            
            // Find all unique combinations
            const allKeys = new Set([...reservationMap.keys(), ...usageMap.keys()]);
            
            allKeys.forEach(key => {
                const [region, vmSize] = key.split('-');
                const reservation = reservationMap.get(key);
                const usage = usageMap.get(key);
                
                const reserved = reservation ? reservation.quantity : 0;
                const actual = usage ? usage.quantity : 0;
                const gap = reserved - actual;
                const cost = reservation ? reservation.cost : 0;
                
                gaps.push({
                    region,
                    vmSize,
                    reserved,
                    actual,
                    gap,
                    costImpact: gap > 0 ? (gap / reserved) * cost : 0,
                    recommendation: getRecommendation(gap, reserved, actual)
                });
            });
            
            return gaps;
        }

        function getRecommendation(gap, reserved, actual) {
            if (gap > 0) {
                const wastePercentage = (gap / reserved) * 100;
                if (wastePercentage > 50) return 'Consider reducing reservation';
                if (wastePercentage > 20) return 'Monitor usage trends';
                return 'Minor over-provisioning';
            } else if (gap < 0) {
                return 'Consider additional reservations';
            }
            return 'Optimal utilization';
        }

        function updateMetrics(reservations, actualVMs, gaps) {
            const totalReservations = reservations.reduce((sum, r) => sum + r.quantity, 0);
            const totalVMs = actualVMs.reduce((sum, vm) => sum + vm.quantity, 0);
            const utilizationRate = totalReservations > 0 ? ((totalVMs / totalReservations) * 100).toFixed(1) : 0;
            const totalCostImpact = gaps.reduce((sum, g) => sum + Math.abs(g.costImpact), 0);
            
            document.getElementById('totalReservations').textContent = totalReservations;
            document.getElementById('activeVMs').textContent = totalVMs;
            document.getElementById('utilizationRate').textContent = `${utilizationRate}%`;
            document.getElementById('costImpact').textContent = `$${totalCostImpact.toLocaleString()}`;
        }

        function createRegionChart(gaps) {
            const ctx = document.getElementById('regionChart').getContext('2d');
            
            const regions = [...new Set(gaps.map(g => g.region))];
            const reservedData = regions.map(region => 
                gaps.filter(g => g.region === region).reduce((sum, g) => sum + g.reserved, 0)
            );
            const actualData = regions.map(region => 
                gaps.filter(g => g.region === region).reduce((sum, g) => sum + g.actual, 0)
            );

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: regions,
                    datasets: [
                        {
                            label: 'Reserved',
                            data: reservedData,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2,
                            borderRadius: 8
                        },
                        {
                            label: 'Actual Usage',
                            data: actualData,
                            backgroundColor: 'rgba(118, 75, 162, 0.8)',
                            borderColor: 'rgba(118, 75, 162, 1)',
                            borderWidth: 2,
                            borderRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function createSizeChart(gaps) {
            const ctx = document.getElementById('sizeChart').getContext('2d');
            
            const vmSizes = [...new Set(gaps.map(g => g.vmSize))];
            const gapData = vmSizes.map(size => {
                const sizeGaps = gaps.filter(g => g.vmSize === size);
                return sizeGaps.reduce((sum, g) => sum + g.gap, 0);
            });

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: vmSizes,
                    datasets: [{
                        data: gapData.map(Math.abs),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(255, 107, 107, 0.8)',
                            'rgba(81, 207, 102, 0.8)',
                            'rgba(255, 193, 7, 0.8)'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }

        function populateGapTable(gaps) {
            const tbody = document.getElementById('gapTableBody');
            tbody.innerHTML = '';
            
            gaps.forEach(gap => {
                const row = document.createElement('tr');
                const gapClass = gap.gap > 0 ? 'gap-negative' : gap.gap < 0 ? 'gap-positive' : '';
                const gapSign = gap.gap > 0 ? '+' : '';
                
                row.innerHTML = `
                    <td>${gap.region}</td>
                    <td>${gap.vmSize}</td>
                    <td>${gap.reserved}</td>
                    <td>${gap.actual}</td>
                    <td class="${gapClass}">${gapSign}${gap.gap}</td>
                    <td>$${Math.round(gap.costImpact).toLocaleString()}</td>
                    <td>${gap.recommendation}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('authStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            // Check if MSAL loaded properly
            setTimeout(() => {
                if (typeof msal === 'undefined') {
                    showStatus('‚ùå Azure authentication library failed to load. Try refreshing the page or use PowerShell method.', 'error');
                    showPowerShellAlternative();
                } else {
                    showStatus('‚úÖ Ready! Configure your Azure settings and click "Connect to Azure" or try "Load Sample Data"', 'success');
                }
            }, 1000); // Give time for library to load
        });

        function showPowerShellAlternative() {
            const authSection = document.querySelector('.auth-section');
            const powershellDiv = document.createElement('div');
            powershellDiv.className = 'status info';
            powershellDiv.style.marginTop = '20px';
            powershellDiv.innerHTML = `
                <h4>üí° Alternative: PowerShell Method</h4>
                <p>If Azure authentication doesn't work, extract your data using PowerShell:</p>
                <div class="code">
# Connect to Azure
Connect-AzAccount

# Get reservations
$reservations = Get-AzReservation | Where-Object {$_.Sku.Name -like "*VM*"}

# Get current VMs
$vms = Get-AzVM -Status | Where-Object {$_.PowerState -eq "VM running"}

# Group and export
$vms | Group-Object Location, HardwareProfile.VmSize | 
    ForEach-Object {
        [PSCustomObject]@{
            Region = $_.Group[0].Location
            VMSize = $_.Group[0].HardwareProfile.VmSize  
            ActualQuantity = $_.Count
        }
    } | Export-Csv "current_vms.csv" -NoTypeInformation

Write-Host "Upload current_vms.csv and compare with reservations manually"
                </div>
            `;
            authSection.appendChild(powershellDiv);
        }
    </script>
</body>
</html>
