<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Azure Reservation Gap Analysis (Live)</title>
  <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .header { background: rgba(255,255,255,.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 20px 40px rgba(0,0,0,.1); border: 1px solid rgba(255,255,255,.2); }
    .header h1 { font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg,#667eea,#764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
    .auth-section { background: rgba(255,255,255,.9); border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,.1) }
    .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap: 15px; margin-bottom: 10px; }
    .input-group { display: flex; flex-direction: column; }
    .input-group label { font-weight: 600; margin-bottom: 5px; color: #555; }
    .input-group input { padding: 12px 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 14px; transition: all .3s ease; background: white; }
    .input-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,.1) }
    .btn { padding: 12px 18px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all .2s ease; text-transform: uppercase; letter-spacing: .5px; font-size: 13px; }
    .btn-primary { background: linear-gradient(135deg,#667eea,#764ba2); color: white; box-shadow: 0 5px 15px rgba(102,126,234,.3) }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 8px 22px rgba(102,126,234,.4) }
    .btn-secondary { background: #f8f9fa; color: #495057; border: 2px solid #dee2e6 }
    .btn-secondary:hover { background: #e9ecef; transform: translateY(-1px) }
    .status { padding: 12px 16px; border-radius: 10px; margin: 12px 0; font-weight: 500; }
    .status.success { background: linear-gradient(135deg,#51cf66,#40c057); color: white; }
    .status.error { background: linear-gradient(135deg,#ff6b6b,#ee5a52); color: white; }
    .status.info { background: linear-gradient(135deg,#74c0fc,#339af0); color: white; }
    .dashboard { display: none; }
    .dashboard.active { display: block; }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap: 25px; margin-bottom: 30px; }
    .metric-card { background: rgba(255,255,255,.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 22px; box-shadow: 0 15px 35px rgba(0,0,0,.1); border: 1px solid rgba(255,255,255,.2); }
    .metric-value { font-size: 2.2rem; font-weight: 700; margin-bottom: 6px; }
    .metric-label { font-size: 1rem; color: #666; font-weight: 500; }
    .metric-trend { font-size: .9rem; margin-top: 8px; padding: 5px 10px; border-radius: 20px; display: inline-block; }
    .trend-positive { background: rgba(81,207,102,.1); color: #51cf66; }
    .trend-negative { background: rgba(255,107,107,.1); color: #ff6b6b; }
    .chart-container, .gap-table { background: rgba(255,255,255,.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 15px 35px rgba(0,0,0,.1); }
    .chart-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 12px; color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: linear-gradient(135deg,#f8f9fa,#e9ecef); font-weight: 600; color: #495057; }
    tr:hover { background: rgba(102,126,234,.05) }
    .gap-positive { color: #51cf66; font-weight: 600; }
    .gap-negative { color: #ff6b6b; font-weight: 600; }
    .setup-instructions { background: rgba(255,255,255,.95); border-radius: 15px; padding: 25px; margin-top: 20px; box-shadow: 0 15px 35px rgba(0,0,0,.1); }
    .setup-instructions h3 { color: #667eea; margin-bottom: 12px; }
    .code { background: #f8f9fa; padding: 10px; border-radius: 6px; font-family: 'Courier New', monospace; margin: 8px 0; overflow-x: auto; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .hint { font-size: 12px; color: #555; margin-top: 6px; }
    .toggle { display: inline-flex; align-items: center; gap: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Azure Reservation Gap Analysis</h1>
      <p>Live analysis of your VM reservations vs. actual usage — no CSVs.</p>
    </div>

    <div class="auth-section">
      <h2>Azure Configuration</h2>
      <div class="config-grid">
        <div class="input-group">
          <label for="clientId">Client ID</label>
          <input type="text" id="clientId" placeholder="Your App registration (public client)" />
        </div>
        <div class="input-group">
          <label for="tenantId">Tenant ID</label>
          <input type="text" id="tenantId" placeholder="Your Entra ID tenant GUID" />
        </div>
        <div class="input-group">
          <label for="subscriptionId">Subscription ID(s)</label>
          <input type="text" id="subscriptionId" placeholder="subId or subId1, subId2" />
          <div class="hint">Use commas for multiple subscriptions. Used by Resource Graph.</div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn btn-primary" id="btnConnect">Connect to Azure</button>
        <button class="btn btn-secondary" id="btnSample">Load Sample Data</button>
        <label class="toggle"><input type="checkbox" id="familyMode" checked /> Use family (instance flexibility) where possible</label>
      </div>
      <div class="config-grid" style="margin-top:10px">
        <div class="input-group">
          <label for="scopeFilter">Reservation scope filter</label>
          <input type=\"text\" id="scopeFilter" placeholder="e.g., Single subscription - Jonas Enterprise" />
          <div class="hint">Exact match, case-insensitive. Leave blank to include all scopes.</div>
        </div>
        <div class="input-group">
          <label>&nbsp;</label>
          <label class="toggle"><input type=\"checkbox\" id="statusFilterSucceeded" checked /> Succeeded reservations only</label>
        </div>
      </div>
      <div id="authStatus" class="status info">Loading…</div>
    </div>

    <div id="dashboard" class="dashboard">
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-value" id="totalReservations">-</div>
          <div class="metric-label">Total Reserved Instances</div>
          <div class="metric-trend" id="reservationTrend">from reservationDetails</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="activeVMs">-</div>
          <div class="metric-label">VMs in scope</div>
          <div class="metric-trend" id="vmTrend">Resource Graph</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="utilizationRate">-</div>
          <div class="metric-label">Avg Utilization (30d)</div>
          <div class="metric-trend" id="utilizationTrend">target ≥85%</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="costImpact">-</div>
          <div class="metric-label">Estimated Monthly Gap Cost</div>
          <div class="metric-trend trend-negative" id="costTrend">estimation</div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-title">Reservation vs Usage by Region</div>
        <canvas id="regionChart" height="160"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-title">VM Size / Family Gap</div>
        <canvas id="sizeChart" height="160"></canvas>
      </div>

      <div class="gap-table">
        <div class="chart-title">Detailed Gap Analysis</div>
        <table id="gapTable">
          <thead>
            <tr>
              <th>Region</th>
              <th>SKU / Size</th>
              <th>Reserved</th>
              <th>Avg Used (30d)</th>
              <th>Count in Scope</th>
              <th>Gap vs Now</th>
              <th>Recommendation</th>
            </tr>
          </thead>
          <tbody id="gapTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="setup-instructions">
      <h3>Setup & required access</h3>
      <ol>
        <li><b>Redirect URI:</b> <code id="redirectUri"></code></li>
        <li><b>MSAL scope:</b> <code>https://management.azure.com/.default</code> (Auth Code + PKCE)</li>
        <li><b>RBAC you’ll need:</b>
          <ul>
            <li><b>Reservations Reader</b> on <code>/providers/Microsoft.Capacity</code> (for listing reservation orders)</li>
            <li><b>Cost Management Reader</b> at subscription or billing scope (for reservation <i>details/summaries</i>)</li>
            <li><b>Reader</b> on each subscription you query (for Resource Graph)</li>
          </ul>
        </li>
      </ol>
      <div class="hint">If you hit CORS or permission issues, use the included proxy pattern (Azure Function) described in the code comments.</div>
    </div>
  </div>

  <script>
    // ====== Globals
    const ARM = 'https://management.azure.com';
    const RESERVATION_API_VERSION = '2022-11-01'; // Microsoft.Capacity
    const CONSUMPTION_API_VERSION = '2024-08-01'; // Microsoft.Consumption
    const ARG_API_VERSION = '2024-04-01';         // Microsoft.ResourceGraph

    let msalInstance; let account; let accessToken; let azureConfig = {}; let regionChart, sizeChart;

    // Sample fallback
    const sampleData = {
      reservations: [
        { reservationId: 'r1', region: 'eastus', skuName: 'Standard_D2s_v3', reservedQty: 10, avgUsed: 8.2 },
        { reservationId: 'r2', region: 'eastus', skuName: 'Standard_D4s_v3', reservedQty: 5, avgUsed: 6.1 },
        { reservationId: 'r3', region: 'westus', skuName: 'Standard_D2s_v3', reservedQty: 8, avgUsed: 7.9 },
        { reservationId: 'r4', region: 'westeurope', skuName: 'Standard_D8s_v3', reservedQty: 3, avgUsed: 2.1 },
        { reservationId: 'r5', region: 'southeastasia', skuName: 'Standard_D2s_v3', reservedQty: 6, avgUsed: 3.7 }
      ],
      runningNow: [
        { region: 'eastus', skuName: 'Standard_D2s_v3', running: 8 },
        { region: 'eastus', skuName: 'Standard_D4s_v3', running: 7 },
        { region: 'westus', skuName: 'Standard_D2s_v3', running: 8 },
        { region: 'westeurope', skuName: 'Standard_D8s_v3', running: 2 },
        { region: 'southeastasia', skuName: 'Standard_D2s_v3', running: 4 },
        { region: 'centralus', skuName: 'Standard_D2s_v3', running: 3 }
      ]
    };

    // ====== UI boot
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('redirectUri').textContent = window.location.origin;
      document.getElementById('btnConnect').addEventListener('click', authenticateAzure);
      document.getElementById('btnSample').addEventListener('click', () => {
        processGapAnalysis(sampleData);
        showStatus('Loaded sample data. Use Connect for live data.', 'success');
      });
      showStatus('Ready. Enter Client/Tenant/Subscriptions and click Connect.', 'success');
    });

    // ====== Auth & token helpers
    function initMSAL() {
      const clientId = document.getElementById('clientId').value.trim();
      const tenantId = document.getElementById('tenantId').value.trim();
      if (!clientId || !tenantId) { showStatus('Please enter Client ID and Tenant ID', 'error'); return false; }
      azureConfig = {
        clientId,
        tenantId,
        subscriptions: (document.getElementById('subscriptionId').value || '').split(',').map(s => s.trim()).filter(Boolean)
      };
      msalInstance = new msal.PublicClientApplication({
        auth: {
          clientId,
          authority: `https://login.microsoftonline.com/${tenantId}`,
          redirectUri: window.location.origin
        },
        cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: true }
      });
      return true;
    }

    async function getToken() {
      const request = { scopes: ['https://management.azure.com/.default'] };
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length) account = accounts[0];
      try {
        const result = await msalInstance.acquireTokenSilent({ ...request, account });
        return result.accessToken;
      } catch (e) {
        const login = await msalInstance.loginPopup(request);
        account = login.account; // set default account
        const result = await msalInstance.acquireTokenSilent({ ...request, account });
        return result.accessToken;
      }
    }

    async function authenticateAzure() {
      try {
        if (!initMSAL()) return;
        showStatus('Authenticating with Azure…', 'info');
        accessToken = await getToken();
        showStatus('Authenticated. Pulling live data…', 'success');
        await loadAzureData();
      } catch (err) {
        console.error(err);
        showStatus(`Authentication failed: ${err.message}`, 'error');
      }
    }

    // ====== ARM helpers
    async function armGET(path) {
      const token = accessToken || await getToken();
      const res = await fetch(`${ARM}${path}`, { headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' } });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}: ${await res.text()}`);
      return res.json();
    }

    async function armPOST(path, body) {
      const token = accessToken || await getToken();
      const res = await fetch(`${ARM}${path}`, { method: 'POST', headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}: ${await res.text()}`);
      return res.json();
    }

    // ====== Data loaders (Reservations + Consumption + ARG)
    async function loadAzureData() {
      try {
        showStatus('Fetching reservations & utilization…', 'info');

        // 1) List Reservation Orders
        const orders = await armGET(`/providers/Microsoft.Capacity/reservationOrders?api-version=${RESERVATION_API_VERSION}`);
        const orderIds = (orders.value || []).map(o => o.name);
        if (!orderIds.length) { showStatus('No reservation orders found in tenant.', 'error'); return; }

        // Read filters from UI now (used below)
        const familyMode = document.getElementById('familyMode').checked;
        const statusSucceededOnly = document.getElementById('statusFilterSucceeded')?.checked ?? true;
        const scopeFilterText = (document.getElementById('scopeFilter')?.value || '').trim().toLowerCase();

        // 2) For each order, list Reservations and map reservationId -> region + sku + scope (apply filters)
        const reservationMeta = new Map();
        for (const orderId of orderIds) {
          const reservations = await armGET(`/providers/Microsoft.Capacity/reservationOrders/${orderId}/reservations?api-version=${RESERVATION_API_VERSION}`);
          (reservations.value || []).forEach(r => {
            const p = r.properties || {};
            const prov = String(p.provisioningState || '').toLowerCase();
            if (statusSucceededOnly && prov !== 'succeeded') return;

            const region = (r.location || p.location || '').toLowerCase();
            const skuName = (r.sku && r.sku.name) || (p.sku && p.sku.name) || 'Unknown';

            const appliedType = String(p.appliedScopeType || '').toLowerCase();
            const displayName = (p.appliedScopeProperties && p.appliedScopeProperties.displayName) ? p.appliedScopeProperties.displayName : '';
            const scopeLabel = appliedType === 'single' ? `single subscription - ${displayName}` : appliedType;

            if (scopeFilterText && scopeLabel.toLowerCase() !== scopeFilterText) return;

            const subRid = p.appliedScopeProperties && p.appliedScopeProperties.subscriptionId;
            let scopeSubId = null;
            if (subRid) {
              const m = String(subRid).match(/\/subscriptions\/([0-9a-f-]+)/i);
              scopeSubId = m ? m[1] : null;
            }
            reservationMeta.set(r.name, { region, skuName, orderId, scopeLabel, scopeSubId });
          });
        }

        // 3) Reservation Details (last 30d) to compute avg used per reservation
        const end = new Date(); end.setUTCDate(end.getUTCDate() - 1);
        const start = new Date(end); start.setUTCDate(end.getUTCDate() - 29);
        const dateFilter = `properties/usageDate ge ${start.toISOString().split('T')[0]} AND properties/usageDate le ${end.toISOString().split('T')[0]}`;

        const allowedResIds = new Set(reservationMeta.keys());
        const reservationsAgg = [];
        for (const orderId of orderIds) {
          const details = await armGET(`/providers/Microsoft.Capacity/reservationorders/${orderId}/providers/Microsoft.Consumption/reservationDetails?$filter=${encodeURIComponent(dateFilter)}&api-version=${CONSUMPTION_API_VERSION}`);
          const rows = details.value || [];
          const byRes = new Map();
          rows.forEach(item => {
            const p = item.properties || {};
            const rid = p.reservationId?.split('/').pop();
            if (!rid || !allowedResIds.has(rid)) return;
            const entry = byRes.get(rid) || { usedHours: 0, days: 0, reservedQty: 0, skuName: p.skuName, ifg: p.instanceFlexibilityGroup };
            entry.usedHours += Number(p.usedHours || 0);
            entry.days += 1;
            entry.reservedQty = Math.max(entry.reservedQty, Number(p.totalReservedQuantity || 0));
            byRes.set(rid, entry);
          });

          for (const [rid, v] of byRes) {
            const meta = reservationMeta.get(rid) || {};
            const avgUsed = v.days ? (v.usedHours / (24 * v.days)) : 0;
            reservationsAgg.push({ reservationId: rid, region: meta.region, skuName: meta.skuName || v.skuName, reservedQty: v.reservedQty, avgUsed, family: v.ifg });
          }
        }

        // 4) Get current running VMs by size+region via Resource Graph
        showStatus('Querying Resource Graph for VMs…', 'info');
        const subs = azureConfig.subscriptions; // can be empty => tenant scope (needs extra perms)

        const kql = `Resources
| where type =~ 'microsoft.compute/virtualmachines'
| extend vmSize = tostring(properties.hardwareProfile.vmSize)
| summarize running = count() by region = tolower(location), vmSize`;

        let targetSubs = subs;
        const pick = Array.from(new Set(Array.from(reservationMeta.values()).map(x => x.scopeSubId).filter(Boolean))); if (pick.length) targetSubs = pick;
        const argBody = { query: kql };
        if (targetSubs && targetSubs.length) argBody.subscriptions = targetSubs;
        const arg = await armPOST(`/providers/Microsoft.ResourceGraph/resources?api-version=${ARG_API_VERSION}`, argBody);
        const runningNow = (arg.data || []).map(r => ({ region: String(r[0]).toLowerCase(), skuName: String(r[1]), running: Number(r[2]) }));

        // 5) If familyMode, roll up sizes to instanceFlexibilityGroup family (best-effort mapping via prefix)
        const toFamily = (sku) => {
          // e.g., Standard_D4s_v3 -> Dv3 Series (approx). Use IFG from details when present.
          const m = sku.match(/^Standard_([A-Z]+)[\w]*_v(\d+)/i); if (!m) return sku;
          return `${m[1].toUpperCase()}v${m[2]} Series`;
        };

        const reservations = reservationsAgg.map(x => ({
          ...x,
          key: familyMode ? (x.family || toFamily(x.skuName)) : x.skuName
        }));

        const runningKeyed = runningNow.map(x => ({
          ...x,
          key: familyMode ? toFamily(x.skuName) : x.skuName
        }));

        // 6) Build unified matrix by region+key
        const index = new Map();
        const upsert = (region, key, obj) => {
          const k = `${region}|${key}`;
          const cur = index.get(k) || { region, key, reserved: 0, avgUsed: 0, running: 0 };
          index.set(k, { ...cur, ...obj, reserved: cur.reserved + (obj.reserved || 0), avgUsed: cur.avgUsed + (obj.avgUsed || 0), running: cur.running + (obj.running || 0) });
        };

        reservations.forEach(r => upsert(r.region, r.key, { reserved: r.reservedQty, avgUsed: r.avgUsed }));
        runningKeyed.forEach(r => upsert(r.region, r.key, { running: r.running }));

        // 7) Convert to array of rows
        const rows = Array.from(index.values()).sort((a,b) => (a.region+a.key).localeCompare(b.region+b.key));

        // 8) Update UI
        processGapAnalysis({ rows, rawReservations: reservationsAgg, rawRunning: runningNow });
        showStatus('Live data loaded.', 'success');
      } catch (err) {
        console.error(err);
        showStatus(`Failed to load Azure data: ${err.message}`, 'error');
      }
    }

    // ====== Analysis + UI
    function processGapAnalysis(payload) {
      let rows;
      if (payload.rows) {
        rows = payload.rows.map(r => ({
          region: toTitle(r.region),
          vmKey: r.key,
          reserved: r.reserved,
          avgUsed: Number(r.avgUsed.toFixed(1)),
          running: r.running,
          gapNow: Number((r.reserved - r.running).toFixed(1))
        }));
      } else {
        // sample fallback
        const by = new Map();
        const up = (k, o) => { const v = by.get(k) || { region: o.region, vmKey: o.skuName, reserved: 0, avgUsed: 0, running: 0 }; by.set(k, { ...v, reserved: v.reserved + (o.reservedQty||0), avgUsed: v.avgUsed + (o.avgUsed||0) }); };
        payload.reservations.forEach(r => up(`${r.region}|${r.skuName}`, r));
        payload.runningNow.forEach(r => { const k = `${r.region}|${r.skuName}`; const v = by.get(k) || { region: r.region, vmKey: r.skuName, reserved: 0, avgUsed: 0, running: 0 }; v.running += r.running; by.set(k, v); });
        rows = Array.from(by.values()).map(r => ({ region: toTitle(r.region), vmKey: r.vmKey, reserved: r.reserved, avgUsed: Number(r.avgUsed.toFixed(1)), running: r.running, gapNow: Number((r.reserved - r.running).toFixed(1)) }));
      }

      // metrics
      const totalReservations = rows.reduce((s, r) => s + r.reserved, 0);
      const totalRunning = rows.reduce((s, r) => s + r.running, 0);
      const avgUtilization = rows.reduce((s, r) => s + Math.min(r.avgUsed, r.reserved), 0) / (totalReservations || 1) * 100;
      const estMonthlyGapCost = rows.reduce((s, r) => s + Math.max(0, r.reserved - r.avgUsed), 0) * 24 * 30 * 0; // left as 0 without rate card

      document.getElementById('totalReservations').textContent = totalReservations.toLocaleString();
      document.getElementById('activeVMs').textContent = totalRunning.toLocaleString();
      document.getElementById('utilizationRate').textContent = `${avgUtilization.toFixed(1)}%`;
      document.getElementById('costImpact').textContent = '$' + estMonthlyGapCost.toLocaleString();

      // charts
      makeRegionChart(rows);
      makeSizeChart(rows);

      // table
      const tbody = document.getElementById('gapTableBody');
      tbody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        const gapClass = r.gapNow > 0 ? 'gap-negative' : r.gapNow < 0 ? 'gap-positive' : '';
        tr.innerHTML = `<td>${r.region}</td><td>${r.vmKey}</td><td>${r.reserved}</td><td>${r.avgUsed}</td><td>${r.running}</td><td class="${gapClass}">${r.gapNow > 0 ? '+' : ''}${r.gapNow}</td><td>${recommend(r)}</td>`;
        tbody.appendChild(tr);
      });

      document.getElementById('dashboard').classList.add('active');
    }

    function recommend(r) {
      if (r.gapNow > 0) {
        const pct = (r.gapNow / (r.reserved || 1)) * 100;
        if (pct > 50) return 'Reduce / split reservation';
        if (pct > 20) return 'Monitor & right-size';
        return 'Minor over-provisioning';
      }
      if (r.gapNow < 0) return 'Consider more reservations';
      return 'Optimal';
    }

    function makeRegionChart(rows) {
      const byRegion = new Map();
      for (const r of rows) {
        const v = byRegion.get(r.region) || { reserved: 0, running: 0 };
        v.reserved += r.reserved; v.running += r.running; byRegion.set(r.region, v);
      }
      const labels = Array.from(byRegion.keys());
      const reserved = labels.map(l => byRegion.get(l).reserved);
      const running = labels.map(l => byRegion.get(l).running);
      const ctx = document.getElementById('regionChart').getContext('2d');
      regionChart && regionChart.destroy();
      regionChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [ { label: 'Reserved', data: reserved, backgroundColor: 'rgba(102,126,234,.8)', borderColor: 'rgba(102,126,234,1)', borderWidth: 2, borderRadius: 8 }, { label: 'Running', data: running, backgroundColor: 'rgba(118,75,162,.8)', borderColor: 'rgba(118,75,162,1)', borderWidth: 2, borderRadius: 8 } ] }, options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,.05)' } }, x: { grid: { display: false } } } } });
    }

    function makeSizeChart(rows) {
      const byKey = new Map();
      for (const r of rows) {
        const v = byKey.get(r.vmKey) || { gap: 0 };
        v.gap += Math.abs(r.gapNow); byKey.set(r.vmKey, v);
      }
      const labels = Array.from(byKey.keys());
      const data = labels.map(l => byKey.get(l).gap);
      const ctx = document.getElementById('sizeChart').getContext('2d');
      sizeChart && sizeChart.destroy();
      sizeChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: ['rgba(102,126,234,.8)','rgba(118,75,162,.8)','rgba(255,107,107,.8)','rgba(81,207,102,.8)','rgba(255,193,7,.8)'], borderWidth: 3, borderColor: '#fff' }] }, options: { responsive: true, plugins: { legend: { position: 'right' } } } });
    }

    function toTitle(region) {
      if (!region) return '';
      return region.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function showStatus(msg, type='info') {
      const el = document.getElementById('authStatus');
      el.className = `status ${type}`;
      el.textContent = msg;
    }

    // ====== Optional: proxy pattern (Azure Function)
    /*
    If you encounter CORS or want to hide ARM calls, deploy a Function App with Managed Identity and expose two endpoints:
      GET  /api/reservation-summary   -> returns the array built in steps (3) above
      POST /api/arg-running           -> runs the ARG query for the posted subscriptions
    Grant the MI: Reservations Reader on /providers/Microsoft.Capacity, Cost Management Reader, and Reader on target subs.
    Then replace armGET/armPOST with fetch('https://<func>.azurewebsites.net/api/...').
    */
  </script>
</body>
</html>
